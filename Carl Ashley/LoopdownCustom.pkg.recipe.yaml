Description: |
  Clones the Loopdown git repo, builds a custom zipapp version,
  then builds a package installing it to /usr/local/bin.

  BUILD_PYTHON: Python to use for building (pip + zipapp).
  PYTHON_INTERPRETER: Interpreter string embedded in the zipapp shebang.

Identifier: com.github.davidbpirie.pkg.LoopdownCustom
MinimumVersion: 2.3.0

Input:
  NAME: Loopdown
  REPO_URL: https://github.com/carlashley/loopdown.git
  BUILD_PYTHON: python3
  PYTHON_INTERPRETER: /usr/bin/env python3
  PKG_ID: com.github.davidbpirie.pkg.loopdowncustom

Process:
  - Processor: com.github.davidbpirie.SharedProcessors/GitRepoClone
    Arguments:
      repo_url: '%REPO_URL%'
      repo_directory: '%RECIPE_CACHE_DIR%/git_repo'
      replace_existing: True

  - Processor: com.github.davidbpirie.SharedProcessors/RunShellCommand
    Arguments:
      subprocess_args:
        - './build.sh --build-python="%BUILD_PYTHON%" --interpreter="%PYTHON_INTERPRETER%"'
      subprocess_fail_on_error: True
      subprocess_cwd: '%RECIPE_CACHE_DIR%/git_repo'

  - Processor: URLTextSearcher
    Arguments:
      re_pattern: 'VERSION\s*=\s*"(.+)"'
      url: file://%RECIPE_CACHE_DIR%/git_repo/src/loopdown/consts/version_enums.py
      result_output_var_name: version

  - Processor: PkgRootCreator
    Arguments:
      pkgdirs:
        payload: '0775'
        payload/usr: '0755'
        payload/usr/local: '0755'
        payload/usr/local/bin: '0755'
      pkgroot: '%RECIPE_CACHE_DIR%/%NAME%'

  - Processor: Copier
    Arguments:
      source_path: '%RECIPE_CACHE_DIR%/git_repo/dist/loopdown'
      destination_path: '%RECIPE_CACHE_DIR%/%NAME%/payload/usr/local/bin/loopdown'
      overwrite: True

  - Processor: PkgCreator
    Arguments:
      pkg_request:
        chown:
          - group: wheel
            mode: '0755'
            path: usr
            user: root
        id: '%PKG_ID%'
        options: purge_ds_store
        pkgname: '%NAME%-%version%'
        pkgroot: '%RECIPE_CACHE_DIR%/%NAME%/payload'

  - Processor: PathDeleter
    Arguments:
      path_list:
        - '%RECIPE_CACHE_DIR%/git_repo'
        - '%RECIPE_CACHE_DIR%/%NAME%'
